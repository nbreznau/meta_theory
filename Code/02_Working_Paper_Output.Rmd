---
title: "02 Working Paper"
author: "Nate Breznau & Hung H.V. Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

## Setup


```{r setup}

packages <- c('theoRy',
              'QCA',
              'tidyverse',
              'daggity') # daggity is loaded automatically with theoRy, but we include it for citation purposes

pacman::p_load(packages, character.only = T)

```

## Load 01_Data_Setup

```{r data}
load(here::here("Results", "01_Data_Setup.Rdata"))
```

## 1. A Potential Collider


*inclN* = inclusion = what percent of all models have outcome (Y = 1) and this component (X = 1)
*covN* = necessity coverage = what percent of all models with this component (X = 1) have the outcome (Y = 1)
*RoN* = relevence of necessity = is a necessary condition trivial

### Table 3. Model Comparison Stats

```{r tbl3}
tbl3 <- matrix(nrow = 14, ncol = 4)

tbl3[,1] <- c("Model 1 Comparisons", "Reference Model", "Multiverse Criteria", "All Models Compared", "N Comparison Models", "Test Compatible =", "Full Model Compatible =", "Model 7 Comparisons", "Reference Model", "Multiverse Criteria", "All Models compared", "N Comparison Models", "Test Compatible", "Full Model Compatible")

# this can be done with set_matrix

tbl3[,2] <- c("", paste0(ls_theory$formula_matrix$formula[ls_theory$formula_matrix$model == 1],"(Model 1)"), "Models with X1 and X2, and models with X1, X2 and X4", "", nrow(set_matrix_X124), 
              paste0(round(100-(100*(nrow(set_matrix_X124[set_matrix_X124$outcome == 1,])/nrow(set_matrix_X124))),1),"%"),
              paste0(round(100-(100*(nrow(set_matrix_X124[set_matrix_X124$outcome_full == 1,])/nrow(set_matrix_X124))),1),"%"),
              "", paste0(ls_theory$formula_matrix$formula[ls_theory$formula_matrix$model == 7],"(Model 7)"), "Models with X1, X2 and X4", "", nrow(set_matrix_7_X124),
              paste0(round(100-(100*(nrow(set_matrix_7_X124[set_matrix_7_X124$outcome == 1,])/nrow(set_matrix_7_X124))),1),"%"),
              paste0(round(100-(100*(nrow(set_matrix_7_X124[set_matrix_7_X124$outcome_full == 1,])/nrow(set_matrix_7_X124))),1),"%"))

tbl3[,3] <- c("", "", "", "Only Models w X4 Compared", "N Comparison Models", "Test Compatible =", "Full Model Compatible =", "", "", "", "Only Models w X4 Compared", "N Comparison Models", "Test Compatible", "Full Model Compatible")

tbl3[,4] <- c("", "", "", "", nrow(set_matrix_7_X124), 
              paste0(round(100-(100*(nrow(set_matrix_X124_X4only[set_matrix_X124_X4only$outcome == 1,])/nrow(set_matrix_X124_X4only))),1),"%"),
              paste0(round(100-(100*(nrow(set_matrix_X124_X4only[set_matrix_X124_X4only$outcome_full == 1,])/nrow(set_matrix_X124_X4only))),1),"%"),
              "", "", "", "",
              nrow(set_matrix_7_X124_X4only), 
              paste0(round(100-(100*(nrow(set_matrix_7_X124_X4only[set_matrix_7_X124_X4only$outcome == 1,])/nrow(set_matrix_7_X124_X4only))),1),"%"),
              paste0(round(100-(100*(nrow(set_matrix_7_X124_X4only[set_matrix_7_X124_X4only$outcome_full == 1,])/nrow(set_matrix_7_X124_X4only))),1),"%")
              )

write.csv(tbl3, here::here("Results", "Table_3.csv"), row.names = F)
```


### Single Components

```{r qca}
#set_truth <- truthTable(set_matrix_c, "outcome")

set_matrix_X124_pof <- pof(setms = select(set_matrix_X124, -c(model,outcome, Xtest_Y)), outcome = "outcome", data = set_matrix_X124)

set_matrix_full_X124_pof <- pof(setms = select(set_matrix_full_X124, -c(model,outcome, Xtest_Y)), outcome = "outcome", data = set_matrix_full_X124)

set_matrix_7_X124_pof <- pof(setms = select(set_matrix_7_X124, -c(model,outcome, Xtest_Y)), outcome = "outcome", data = set_matrix_7_X124)

set_matrix_full_7_X124_pof <- pof(setms = select(set_matrix_full_7_X124, -c(model,outcome, Xtest_Y)), outcome = "outcome", data = set_matrix_full_7_X124)

set_matrix_X124_pof
set_matrix_full_X124_pof
set_matrix_7_X124_pof
set_matrix_full_7_X124_pof
```


### Multiple Components

#### Minimize

Looking at only positive outcomes (outcome = 1/MAS = {X1}), this procedure tries to find minimal sets of variables that are present in all positive cases, regardless of if these sets are present in outcome = 0 cases.

```{r minimize}

min_results_X124 <- minimize(dplyr::select(set_matrix_X124, -c(model, Xtest_Y)), details = TRUE, outcome = "outcome")

min_results_full_X124 <- minimize(dplyr::select(set_matrix_full_X124, -c(model, Xtest_Y)), details = TRUE, outcome = "outcome")

min_results_7_X124 <- minimize(dplyr::select(set_matrix_7_X124, -c(model, Xtest_Y)), details = TRUE, outcome = "outcome")

min_results_full_7_X124 <- minimize(dplyr::select(set_matrix_full_7_X124, -c(model, Xtest_Y)), details = TRUE, outcome = "outcome")

```


#### Subsets

*inclN* = inclusion = what percent of all models have outcome (Y = 1) and this component (X = 1)
*covN* = necessity coverage = what percent of all models with this component (X = 1) have the outcome (Y = 1)
*RoN* = relevence of necessity = how trivial is a necessary condition trivial = 0 or relevant = 1
```{r qca}
sup_subset_X124 <- superSubset(dplyr::select(set_matrix_X124, -c(model, Xtest_Y)), outcome = "outcome", ron.cut = 0.001)

#There are no combinations that are not compatible with ron > 0

#sup_subset_full_X124 <- superSubset(dplyr::select(set_matrix_full_X124, -c(model, Xtest_Y)), outcome = "outcome", ron.cut = 0.001)

sup_subset_7_X124 <- superSubset(dplyr::select(set_matrix_7_X124, -c(model, Xtest_Y)), outcome = "outcome", ron.cut = 0.001)

sup_subset_full_7_X124 <- superSubset(dplyr::select(set_matrix_full_7_X124, -c(model, Xtest_Y)), outcome = "outcome", ron.cut = 0.001)

sup_subset_X124
sup_subset_full_X124
sup_subset_7_X124
sup_subset_full_7_X124


```


## Colophon

```{r cphon}
sessionInfo()
```

## References


```{r cite}
packages %>%
  map(citation) %>%
  print(style = "text")
```
